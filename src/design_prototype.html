<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="おにぎりにぎりき PRO - スマートおにぎり成形デバイスコントローラー">
    <title>おにぎりにぎりき PRO</title>

    <!-- Fonts: パフォーマンス向上のためpreconnectを使用 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Noto+Sans+JP:wght@400;700;900&family=Noto+Sans+Khmer:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /*
         * CSS Variables (Custom Properties)
         * メンテナンス性を高めるため、色やサイズを一元管理します。
         */
        :root {
            /* Light Theme (Default) */
            --bg-color: #f2f2f7;
            --surface-color: #ffffff;
            --surface-light: #e5e5ea;

            --primary: #FF4B4B;
            --primary-glow: rgba(255, 75, 75, 0.3);
            --accent: #FF9F43;

            --text-main: #1c1c1e;
            --text-sub: #8e8e93;

            --success: #34c759;
            --warning: #ffcc00;
            --danger: #ff3b30;

            --card-radius: 20px;
            --btn-radius: 12px;
            --transition-default: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-bounce: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);

            --z-header: 100;
            --z-nav: 200;
            --z-overlay: 500;
            --z-toast: 1000;

            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.03);
            --shadow-hard: 0 10px 20px rgba(0, 0, 0, 0.08);
        }



        /* 
         * Base Styles
         */
        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', 'Noto Sans JP', 'Noto Sans Khmer', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            padding-bottom: 5.5rem;
            /* Bottom nav spacing */
            user-select: none;
            -webkit-user-select: none;
        }

        /* 
         * Utility Classes
         */
        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-sm {
            gap: 5px;
        }

        .gap-md {
            gap: 10px;
        }

        .text-center {
            text-align: center;
        }

        .text-sub {
            color: var(--text-sub);
        }

        .font-bold {
            font-weight: 700;
        }

        .font-black {
            font-weight: 900;
        }

        /* --- Header --- */
        header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }



        .brand {
            font-size: 1.15rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            white-space: nowrap;
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            background: var(--surface-light);
            border-radius: 20px;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.8);
            }
        }

        /* --- Layout --- */
        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 1rem 1.25rem;
            box-sizing: border-box;
        }

        .section-title {
            font-size: 0.85rem;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 25px 0 10px 0;
            display: flex;
            justify-content: space-between;
        }

        /* --- Core Components --- */

        /* Onigiri Button (Main Action) */
        .onigiri-btn {
            width: auto;
            height: auto;
            margin: 20px auto 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: var(--transition-bounce);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
            filter: drop-shadow(0 15px 15px rgba(0, 0, 0, 0.15));
        }

        .onigiri-btn:active {
            transform: scale(0.92) translateY(5px);
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.25));
        }

        .onigiri-btn.animate {
            animation: pulse-click 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pulse-click {
            0% {
                transform: scale(1);
            }

            30% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
            }
        }

        .onigiri-btn .text {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--text-main);
            position: relative;
            z-index: 2;
            letter-spacing: 4px;
            margin-top: 0;
            padding-bottom: 10px;
            /* Slight visual adjustment for triangle shape */
        }

        /* Preset Buttons */
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            background: var(--surface-light);
            border: none;
            color: var(--text-main);
            padding: 16px 12px;
            border-radius: var(--btn-radius);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-default);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            width: 100%;
            min-height: 64px; /* Enlarged for touch (No.22) */
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.95);
            opacity: 0.9;
        }

        /* Preset Active States */
        .btn.active {
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn[data-preset="soft"].active {
            background: linear-gradient(135deg, #FF9F43, #FFB167);
        }

        .btn[data-preset="normal"].active {
            background: linear-gradient(135deg, #FF4B4B, #FF7676);
        }

        .btn[data-preset="hard"].active {
            background: linear-gradient(135deg, #636e72, #2d3436);
        }

        .btn[data-preset="barikata"].active {
            background: linear-gradient(135deg, #2d3436, #000000);
        }

        /* Other buttons */
        .btn-defaults.active {
            background: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            font-weight: 800;
            box-shadow: 0 8px 20px rgba(255, 59, 48, 0.3);
        }

        .btn-small-text {
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        /* Card */
        .card {
            background: var(--surface-color);
            border-radius: var(--card-radius);
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }



        .stat-card {
            text-align: center;
            padding: 15px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-sub);
            text-transform: uppercase;
        }

        /* Sliders */
        .range-wrapper {
            margin-top: 10px;
        }

        .range-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-sub);
        }

        .range-value {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 900;
            line-height: 1;
        }

        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 32px; /* Enlarged for touch (No.22) */
            width: 32px;  /* Enlarged for touch (No.22) */
            border-radius: 50%;
            background: var(--surface-color);
            border: 2px solid var(--text-main);
            margin-top: -12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
        }

        /* Toasts */
        #toast-container {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
            animation: toastIn 0.3s forwards, toastOut 0.3s 2.7s forwards;
        }

        @keyframes toastIn {
            from {
                transform: translateY(-15px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* @keyframes toastOut is defined dynamically or assumes removal */
        @keyframes toastOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }

            to {
                transform: translateY(-15px);
                opacity: 0;
            }
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 30px 0;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            z-index: var(--z-nav);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.02);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }



        .nav-item {
            color: var(--text-sub);
            text-align: center;
            font-size: 0.75rem;
            transition: var(--transition-default);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            position: relative;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: 800;
        }

        .nav-item .icon {
            width: 1.6rem;
            height: 1.6rem;
            transition: var(--transition-default);
            fill: currentColor;
        }

        .nav-item.active .icon {
            transform: translateY(-2px);
            filter: drop-shadow(0 4px 8px var(--primary-glow));
        }

        /* Overlays */
        .active-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: var(--z-overlay);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .active-overlay.visible {
            display: flex;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .overlay-content {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* Circular Progress */
        .progress-ring-wrapper {
            position: relative;
            width: 240px;
            height: 240px;
            margin: 0 auto 30px;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear;
            stroke: var(--primary);
            stroke-linecap: round;
        }

        .progress-ring__background {
            stroke: #efeff4;
        }

        .timer-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .timer-current {
            font-size: 4.5rem;
            font-weight: 900;
            color: var(--text-main);
            line-height: 1;
        }

        .timer-unit {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-sub);
            margin-top: 5px;
        }

        /* Settings specific */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-row-border {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        select {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 5px;
            background: white;
            font-size: 1rem;
        }

        /* Icons */
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            fill: currentColor;
            overflow: visible;
        }

        .icon-large {
            width: 1.5rem;
            height: 1.5rem;
            fill: currentColor;
        }

        /* --- Result Screen Enhancements --- */
        #overlay-result {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(240, 240, 255, 0.95));
        }

        .result-icon-wrapper {
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        .result-title {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* Confetti */
        .confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: confetti-fall linear forwards;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        /* --- View Transitions --- */
        ::view-transition-group(app-header) { z-index: 100; }
        ::view-transition-group(bottom-nav) { z-index: 200; }
        
        header { view-transition-name: app-header; }
        .bottom-nav { view-transition-name: bottom-nav; }
        /* Only applying identifier to the visible section happens automatically if others are display:none */
        .view-section { view-transition-name: main-content; }

        ::view-transition-old(main-content),
        ::view-transition-new(main-content) {
            animation-duration: 0.3s;
            animation-timing-function: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Forward (Slide Left) */
        :root[data-transition="forward"] ::view-transition-old(main-content) {
            animation-name: slideOutLeft;
        }
        :root[data-transition="forward"] ::view-transition-new(main-content) {
            animation-name: slideInRight;
        }

        /* Backward (Slide Right) */
        :root[data-transition="backward"] ::view-transition-old(main-content) {
            animation-name: slideOutRight;
        }
        :root[data-transition="backward"] ::view-transition-new(main-content) {
            animation-name: slideInLeft;
        }

        @keyframes slideOutLeft { to { transform: translateX(-20%); opacity: 0; } }
        @keyframes slideInRight { from { transform: translateX(20%); opacity: 0; } }
        @keyframes slideOutRight { to { transform: translateX(20%); opacity: 0; } }
        @keyframes slideInLeft { from { transform: translateX(-20%); opacity: 0; } }
    </style>
</head>

<body>
    <!-- SVG Library (Sprite) -->
    <svg style="display:none">
        <symbol id="icon-house" viewBox="0 0 576 512">
            <path
                d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 25.5-20.6 46.1-46.1 46.1H354.1c-14.1 0-25.5-11.4-25.5-25.5V361.9c0-14.1-11.4-25.5-25.5-25.5h-32c-14.1 0-25.5 11.4-25.5 25.5v106.5c0 14.1-11.4 25.5-25.5 25.5H110c-25.5 0-46.1-20.6-46.1-46.1l.6-160.2H32c-17.1 0-32-14.1-32-32.1 0-9 3.5-17.5 9.9-24L252.1 6.1c11.6-11.6 30.4-11.6 42 0L565.9 231.5c6.4 6.5 9.9 15 9.9 24z" />
        </symbol>
        <symbol id="icon-chart" viewBox="0 0 448 512">
            <path
                d="M160 80c0-26.5 21.5-48 48-48h32c26.5 0 48 21.5 48 48v352c0 26.5-21.5 48-48 48h-32c-26.5 0-48-21.5-48-48V80zM0 272c0-26.5 21.5-48 48-48h32c26.5 0 48 21.5 48 48v160c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V272zM368 176h32c26.5 0 48 21.5 48 48v208c0 26.5-21.5 48-48 48h-32c-26.5 0-48-21.5-48-48V224c0-26.5 21.5-48 48-48z" />
        </symbol>
        <symbol id="icon-gear" viewBox="0 0 512 512">
            <path
                d="M487.4 315.7l-42.6-24.6c4.3-23.2 4.3-47 0-70.2l42.6-24.6c4.9-2.8 7.1-8.6 5.5-14-11.1-35.6-30-67.8-54.7-94.6-3.8-4.1-10-5.1-14.8-2.3L380.8 110c-17.9-15.4-38.5-27.3-60.8-35.1V25.8c0-5.6-3.9-10.5-9.3-11.7-36.5-8.2-74.7-8.2-111.2 0-5.4 1.2-9.3 6.1-9.3 11.7v49.1c-22.3 7.9-42.9 19.8-60.8 35.1L82.5 85.3c-4.8-2.8-11-1.9-14.8 2.3-24.7 26.7-43.6 58.9-54.7 94.6-1.7 5.4 .6 11.2 5.5 14l42.6 24.6c-4.3 23.2-4.3 47 0 70.2l-42.6 24.6c-4.9 2.8-7.1 8.6-5.5 14 11.1 35.6 30 67.8 54.7 94.6 3.8 4.1 10 5.1 14.8 2.3l42.6-24.6c17.9 15.4 38.5 27.3 60.8 35.1v49.1c0 5.6 3.9 10.5 9.3 11.7 36.5 8.2 74.7 8.2 111.2 0 5.4-1.2 9.3-6.1 9.3-11.7v-49.1c22.3-7.9 42.9-19.8 60.8-35.1l42.6 24.6c4.8 2.8 11 1.9 14.8-2.3 24.7-26.7 43.6-58.9 54.7-94.6 1.5-5.5-.7-11.3-5.6-14.1zM256 336c-44.1 0-80-35.9-80-80s35.9-80 80-80 80 35.9 80 80-35.9 80-80 80z" />
        </symbol>
        <symbol id="icon-save" viewBox="0 0 448 512">
            <path
                d="M433.9 129.9l-83.9-83.9c-9.4-9.4-22.2-14.1-35.3-14.1h-20.7V176c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V165.3c0-13.1-4.7-25.9-14.1-35.4zM352 432H96V288c0-17.7 14.3-32 32-32h192c17.7 0 32 14.3 32 32v144z" />
        </symbol>
        <symbol id="icon-moon" viewBox="0 0 512 512">
            <path
                d="M283.2 512c78.96 0 151.2-31.22 204.7-82.01c5.242-4.992 4.293-13.88-1.953-17.48c-26.6-15.34-56.23-23.73-86.41-23.73c-97.16 0-176-78.84-176-176c0-40.45 13.56-77.94 36.43-108.3c3.707-4.918 1.156-11.97-4.707-13.62C92.93 72.88 0 169.8 0 288C0 411.7 126.8 512 283.2 512z" />
        </symbol>
        <symbol id="icon-sun" viewBox="0 0 512 512">
            <path
                d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96s96-43.1 96-96S308.9 160 256 160zM256 0C273.7 0 288 14.33 288 32V64C288 81.67 273.7 96 256 96C238.3 96 224 81.67 224 64V32C224 14.33 238.3 0 256 0zM57.55 102.8C65.57 91.56 81.16 89.02 92.4 97.04C103.6 105.1 106.2 120.7 98.15 131.9L75.46 163.7C67.44 174.9 51.85 177.5 40.61 169.4C29.37 161.4 26.81 145.8 34.86 134.6L57.55 102.8zM413.9 131.9C405.8 120.7 408.4 105.1 419.6 97.04C430.8 89.02 446.4 91.56 454.4 102.8L477.1 134.6C485.2 145.8 482.6 161.4 471.4 169.4C460.2 177.5 444.6 174.9 436.5 163.7L413.9 131.9zM256 416C238.3 416 224 430.3 224 448V480C224 497.7 238.3 512 256 512C273.7 512 288 497.7 288 480V448C288 430.3 273.7 416 256 416zM98.15 380.1C106.2 391.3 103.6 406.9 92.4 414.1C81.16 422.1 65.57 420.4 57.55 409.2L34.86 377.4C26.81 366.2 29.37 350.6 40.61 342.6C51.85 334.5 67.44 337.1 75.46 348.3L98.15 380.1zM454.4 409.2C446.4 420.4 430.8 422.1 419.6 414.1C408.4 406.9 405.8 391.3 413.9 380.1L436.5 348.3C444.6 337.1 460.2 334.5 471.4 342.6C482.6 350.6 485.2 366.2 477.1 377.4L454.4 409.2zM0 256C0 238.3 14.33 224 32 224H64C81.67 224 96 238.3 96 256C96 273.7 81.67 288 64 288H32C14.33 288 0 273.7 0 256zM448 224C430.3 224 416 238.3 416 256C416 273.7 430.3 288 448 288H480C497.7 288 512 273.7 512 256C512 238.3 497.7 224 480 224H448z" />
        </symbol>
        <symbol id="icon-onigiri" viewBox="0 0 512 512">
            <path d="M400.8,272.9l-86.1-130.4c-13.1-19.8-35-31.6-58.7-31.6l0,0c-23.7,0-45.7,11.8-58.7,31.6l-86.1,130.4
	c-14.5,22-15.7,48.9-3.2,72.1c12.5,23.2,35.7,37,62,37h172.1c26.3,0,49.5-13.8,62-37S415.3,294.9,400.8,272.9L400.8,272.9z
	 M395.2,340.3c-10.7,19.9-30.6,31.8-53.2,31.8H331V255.5H181V372h-11.1c-22.6,0-42.5-11.9-53.2-31.8s-9.7-43,2.8-61.9L205.6,148
	c11.2-17,30.1-27.1,50.4-27.1s39.2,10.1,50.4,27.1l86.1,130.4C404.9,297.2,405.9,320.4,395.2,340.3L395.2,340.3z"
                fill="currentColor" />
        </symbol>
    </svg>

    <div id="toast-container"></div>

    <header class="flex justify-between items-center">
        <div class="brand">
            <div class="flex flex-col">
                <span data-i18n="brand1">おにぎりにぎりき</span>
                <span data-i18n="brand2">にぎにぎ</span>
            </div>
        </div>
        <div class="flex items-center gap-md">

            <div class="status-badge flex items-center gap-sm">
                <div class="status-dot"></div> <span data-i18n="status_ready">準備完了</span>
            </div>
        </div>
    </header>

    <!-- Main View -->
    <main id="view-main" class="container view-section">
        <section class="hero">
            <!-- JS hooks via ID/Class, no onclick -->
            <button id="btn-squeeze" class="onigiri-btn" aria-label="握る">
                <svg viewBox="0 0 512 512"
                    style="width: 180px; height: 180px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">
                    <use href="#icon-onigiri" />
                </svg>
                <div class="text" data-i18n="btn_squeeze" style="margin-top: 10px; font-size: 1.2rem;">握る</div>
            </button>
        </section>

        <div class="section-title"><span data-i18n="hdr_presets">プリセット</span></div>
        <section class="grid-4" id="preset-list">
            <button class="btn active" data-preset="soft">
                <div class="btn-small-text" data-i18n="pst_soft">やわらか</div>
            </button>
            <button class="btn" data-preset="normal">
                <div class="btn-small-text" data-i18n="pst_normal">ふつう</div>
            </button>
            <button class="btn" data-preset="hard">
                <div class="btn-small-text" data-i18n="pst_hard">かため</div>
            </button>
            <button class="btn" data-preset="barikata">
                <div class="btn-small-text" data-i18n="pst_barikata">ばりかた</div>
            </button>
        </section>

        <div class="section-title" data-i18n="hdr_manual">手動調整</div>
        <section class="card">
            <div class="range-wrapper">
                <div class="range-header"><span data-i18n="lbl_strength_angle">強さ (角度)</span><span class="range-value"
                        id="val-angle">180°</span></div>
                <input type="range" id="input-angle" min="0" max="270" value="180">
            </div>
            <div class="range-wrapper">
                <div class="range-header"><span data-i18n="lbl_duration">時間</span><span class="range-value"
                        id="val-time">3.0s</span></div>
                <input type="range" id="input-time" min="0.5" max="10" step="0.5" value="3.0">
            </div>
        </section>
    </main>

    <!-- Data View -->
    <div id="view-data" class="container view-section hidden">
        <div class="section-title" data-i18n="hdr_stats">統計</div>
        <div class="grid-2">
            <div class="card stat-card">
                <span class="stat-label" data-i18n="lbl_total_count">総握り回数</span>
                <span class="stat-value" id="stat-total">0</span>
            </div>
            <div class="card stat-card">
                <span class="stat-label" data-i18n="lbl_avg_time">平均時間</span>
                <span class="stat-value" id="stat-avg">0.0<small style="font-size:0.8rem">s</small></span>
            </div>
        </div>

        <div class="section-title" data-i18n="lbl_chart_weekly">週間活動量</div>
        <div class="card">
            <canvas id="chart-weekly" style="max-height: 200px;"></canvas>
        </div>

        <div class="section-title" data-i18n="lbl_chart_preset">好みの硬さ</div>
        <div class="card">
            <canvas id="chart-preset" style="max-height: 200px;"></canvas>
        </div>

        <div class="section-title" data-i18n="hdr_history">履歴</div>
        <section class="card" style="padding:0">
            <ul id="history-list" style="list-style:none; padding:0; margin:0"></ul>
        </section>
    </div>

    <!-- Settings View -->
    <div id="view-settings" class="container view-section hidden">
        <div class="section-title" data-i18n="hdr_basic_settings">基本設定</div>
        <section class="card">
            <div class="range-header">
                <span data-i18n="lbl_max_squeeze">最大制限 (安全)</span>
                <span class="range-value" id="val-limit">90°</span>
            </div>
            <input type="range" id="input-limit" min="0" max="270" value="90">

            <div class="range-header" style="margin-top:20px">
                <span data-i18n="lbl_return_speed">戻り速度</span>
                <span class="range-value" id="val-speed">0.1s</span>
            </div>
            <input type="range" id="input-speed" min="0.1" max="2.0" step="0.1" value="0.1">
        </section>

        <div class="section-title" data-i18n="hdr_advanced_settings">詳細設定 / デバッグ</div>
        <section class="card">
            <div class="range-header">
                <span data-i18n="lbl_servo_debug">サーボ手動位置</span>
                <span class="range-value" id="val-debug">270°</span>
            </div>
            <input type="range" id="input-debug" min="0" max="270" value="270">
            <p style="font-size:0.75rem; color:var(--danger); margin-top:8px; font-weight:600"
                data-i18n="msg_debug_warn">⚠ 注意: 即座に動作します</p>
        </section>

        <div class="section-title" data-i18n="hdr_system">システム</div>
        <section class="card">
            <div class="setting-row">
                <span data-i18n="lbl_language" class="font-bold">言語 / Language</span>
                <select id="select-lang">
                    <option value="ja">日本語</option>
                    <option value="km">ភាសាខ្មែរ</option>
                </select>
            </div>

            <div class="setting-row setting-row-border">
                <span data-i18n="lbl_device_name" class="font-bold">SSID</span>
                <span id="device-name" class="font-black text-sub">--</span>
            </div>
            <div class="setting-row setting-row-border">
                <span data-i18n="lbl_your_device" class="font-bold">あなたのデバイス</span>
                <span id="your-device" class="font-bold" style="color:var(--primary)">--</span>
            </div>
            <div class="setting-row setting-row-border">
                <span data-i18n="lbl_firmware_date" class="font-bold">FW更新日時</span>
                <span id="fw-date" class="font-black text-sub">2026/01/11 11:55</span>
            </div>
            <div class="setting-row setting-row-border">
                <span data-i18n="lbl_connected_devices" class="font-bold">接続デバイス数</span>
                <span id="device-count" class="font-black" style="color:var(--primary); font-size:1.2rem">--</span>
            </div>
            <div id="device-list-wrapper"
                style="margin-top:10px; font-size:0.85rem; color:var(--text-sub); border-top:1px dashed #eee; padding-top:10px; display:none">
                <div class="font-bold" style="margin-bottom:5px" data-i18n="lbl_accessing_devices">アクセス中の一覧:</div>
                <div id="device-list" class="flex" style="flex-wrap:wrap; gap:5px"></div>
            </div>
        </section>

        <div style="padding: 10px 0 20px">
            <button id="btn-save-settings" class="btn active btn-defaults"
                style="height:60px; font-size:1.1rem; flex-direction:row; justify-content:center; gap:10px">
                <svg class="icon-large">
                    <use href="#icon-save" />
                </svg>
                <span data-i18n="btn_save">設定を保存</span>
            </button>
        </div>
    </div>

    <!-- Active Overlay -->
    <div id="overlay-active" class="active-overlay">
        <div class="overlay-content">
            <div class="progress-ring-wrapper">
                <svg class="progress-ring" width="240" height="240">
                    <circle class="progress-ring__background" stroke-width="12" fill="transparent" r="108" cx="120"
                        cy="120" />
                    <circle id="progress-ring-circle" class="progress-ring__circle" stroke-width="12" fill="transparent"
                        r="108" cx="120" cy="120" />
                </svg>
                <div class="timer-display">
                    <div id="timer-current" class="timer-current">0.0</div>
                    <div class="timer-unit">SEC</div>
                </div>
            </div>
            <div class="card">
                <div class="flex justify-between items-center">
                    <div style="text-align:left">
                        <div class="text-sub" style="font-size:0.75rem" data-i18n="lbl_settings">設定</div>
                        <div id="active-preset-name" class="font-black"
                            style="color:var(--text-main); font-size:1.1rem">--</div>
                    </div>
                    <div id="connection-status-indicator"
                        style="font-size:0.75rem; color:var(--success); display:flex; align-items:center; gap:5px">
                        <div class="status-dot" style="width:6px; height:6px; animation:none"></div>
                        CONNECTED
                    </div>
                </div>
            </div>
            <div class="grid-2" style="margin-top:20px">
                <button class="btn" id="btn-pause" style="height:55px"><span data-i18n="btn_pause">一時停止</span></button>
                <button class="btn btn-danger" id="btn-stop" style="height:55px"><span
                        data-i18n="btn_stop">中止</span></button>
            </div>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="overlay-result" class="active-overlay">
        <div class="confetti-container" id="confetti-container"></div>
        <div class="overlay-content" style="z-index: 20;">
            <div class="result-icon-wrapper" style="color:var(--success); font-size:4rem; margin-bottom:10px">✓</div>
            <h2 class="result-title" data-i18n="msg_complete">完成しました！</h2>
            <div class="card" style="margin:20px 0; background:rgba(255,255,255,0.8);">
                <div class="flex justify-between" style="margin-bottom:5px">
                    <span data-i18n="lbl_type">種類</span> <span id="res-type">--</span>
                </div>
                <div class="flex justify-between">
                    <span data-i18n="lbl_time">時間</span> <span id="res-time">--</span>
                </div>
            </div>
            <button class="btn active btn-defaults" id="btn-result-ok">OK</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" data-target="view-main">
            <svg class="icon">
                <use href="#icon-house" />
            </svg><span data-i18n="nav_control">操作</span>
        </div>
        <div class="nav-item" data-target="view-data">
            <svg class="icon">
                <use href="#icon-chart" />
            </svg><span data-i18n="nav_data">データ</span>
        </div>
        <div class="nav-item" data-target="view-settings">
            <svg class="icon">
                <use href="#icon-gear" />
            </svg><span data-i18n="nav_settings">設定</span>
        </div>
    </nav>

    <script>
        /**
         * App Logic - Encapsulated to prevent global pollution
         */
        (function () {
            // Configuration & Constants
            const CONFIG = {
                api: {
                    squeeze: '/squeeze',
                    stop: '/stop',
                    status: '/status',
                    save: '/save',
                    config: '/config',
                    debug: '/debug',
                    register: '/register_client'
                },
                presets: {
                    'soft': { angle: 220, duration: 4.0 },
                    'normal': { angle: 180, duration: 3.0 },
                    'hard': { angle: 140, duration: 2.5 },
                    'barikata': { angle: 100, duration: 2.0 }
                },
                updateInterval: 5000
            };

            const TRANSLATIONS = {
                'ja': {
                    'brand1': 'おにぎりにぎりき', 'brand2': 'にぎにぎ', 'status_ready': '準備完了',
                    'lbl_settings': '設定', 'btn_pause': '一時停止', 'btn_resume': '再開', 'btn_stop': '中止',
                    'msg_complete': '完成しました！', 'btn_squeeze': '握る', 'hdr_presets': 'プリセット',
                    'pst_soft': 'やわらか', 'pst_normal': 'ふつう', 'pst_hard': 'かため', 'pst_barikata': 'ばりかた', 'pst_custom': 'カスタム',
                    'hdr_manual': '手動調整', 'lbl_strength_angle': '強さ (角度)', 'lbl_duration': '時間',
                    'hdr_history': '履歴', 'hdr_safety': '安全設定', 'lbl_max_squeeze': '最大制限',
                    'hdr_debug': 'デバッグ', 'lbl_servo_debug': 'サーボ移動', 'msg_debug_warn': '注意: 即座に動作します',
                    'hdr_system': 'システム', 'lbl_language': '言語', 'btn_save': '保存', 'nav_control': '操作',
                    'nav_data': 'データ', 'nav_settings': '設定', 'lbl_connected_devices': '接続デバイス', 'lbl_type': '種類', 'lbl_time': '時間',
                    'lbl_return_speed': '戻り速度', 'msg_save_ok': '保存しました', 'msg_lang_ok': '言語を変更しました', 'msg_stop_ok': '中止しました',
                    'hdr_stats': '統計', 'lbl_total_count': '総握り回数', 'lbl_avg_time': '平均時間', 'hdr_basic_settings': '基本設定', 'hdr_advanced_settings': '詳細設定 / デバッグ', 'lbl_device_name': 'SSID (この機器)', 'lbl_your_device': 'あなたのデバイス', 'lbl_accessing_devices': 'アクセス中の端末', 'lbl_firmware_date': 'FW更新日時',
                    'lbl_chart_weekly': '週間活動量', 'lbl_chart_preset': '好みの硬さ'
                },
                'km': {
                    'brand1': 'អ្នកផលិតអូនីហ្គីរី', 'brand2': 'ប្រូ', 'status_ready': 'រួចរាល់',
                    'lbl_settings': 'កំណត់', 'btn_pause': 'ផ្អាក', 'btn_resume': 'បន្ត', 'btn_stop': 'ឈប់',
                    'msg_complete': 'រួចរាល់!', 'btn_squeeze': 'ច្របាច់', 'hdr_presets': 'ការកំណត់ជាមុន',
                    'pst_soft': 'ទន់', 'pst_normal': 'ធម្មតា', 'pst_hard': 'រឹង', 'pst_barikata': 'រឹងខ្លាំង', 'pst_custom': 'ផ្ទាល់ខ្លួន',
                    'hdr_manual': 'ដោយដៃ', 'lbl_strength_angle': 'មុំ', 'lbl_duration': 'ពេល',
                    'hdr_history': 'ប្រវត្តិ', 'hdr_safety': 'សុវត្ថិភាព', 'lbl_max_squeeze': 'ដែនកំណត់',
                    'hdr_debug': 'Debug', 'lbl_servo_debug': 'មុំ Servo', 'msg_debug_warn': 'ប្រយ័ត្ន៖ រត់ភ្លាមៗ',
                    'hdr_system': 'ប្រព័ន្ធ', 'lbl_language': 'ភាសា', 'btn_save': 'រក្សាទុក', 'nav_control': 'បញ្ជា',
                    'nav_data': 'ទិន្នន័យ', 'nav_settings': 'កំណត់', 'lbl_connected_devices': 'ឧបករណ៍', 'lbl_type': 'ប្រភេទ', 'lbl_time': 'ពេល',
                    'lbl_return_speed': 'ល្បឿនត្រឡប់', 'msg_save_ok': 'បានរក្សាទុក', 'msg_lang_ok': 'បានប្តូរភាសា', 'msg_stop_ok': 'បានឈប់',
                    'hdr_stats': 'ស្ថិតិ', 'lbl_total_count': 'ចំនួនសរុប', 'lbl_avg_time': 'ពេលមធ្យម', 'hdr_basic_settings': 'ការកំណត់មូលដ្ឋាន', 'hdr_advanced_settings': 'ការកំណត់កម្រិតខ្ពស់', 'lbl_device_name': 'ឈ្មោះ AP', 'lbl_your_device': 'ឧបករណ៍របស់អ្នក', 'lbl_accessing_devices': 'ឧបករណ៍ក្នុងប្រព័ន្ធ', 'lbl_firmware_date': 'កាលបរិច្ឆេទ Firmware',
                    'lbl_chart_weekly': 'សកម្មភាពប្រចាំសប្តាហ៍', 'lbl_chart_preset': 'ចំណូលចិត្ត'
                }
            };

            // State Management
            class Store {
                constructor() {
                    this.state = {
                        count: 0,
                        totalDuration: 0,
                        isSqueezing: false,
                        angle: 180,
                        duration: 3.0,
                        activePresetName: 'normal',
                        minLimit: 90,
                        returnSpeed: 0.1,
                        isPaused: false,
                        pausedAt: 0,
                        lang: 'ja',
                        presetStats: { soft: 0, normal: 0, hard: 0, barikata: 0, custom: 0 }
                    };
                    this.load();
                }

                load() {
                    this.state.count = parseInt(localStorage.getItem('stats_count') || '0');
                    this.state.totalDuration = parseFloat(localStorage.getItem('stats_duration') || '0');
                    this.state.lang = localStorage.getItem('app_lang') || 'ja';
                    this.state.presetStats = JSON.parse(localStorage.getItem('stats_presets') || '{"soft":0,"normal":0,"hard":0,"barikata":0,"custom":0}');
                }

                saveStats() {
                    localStorage.setItem('stats_count', this.state.count);
                    localStorage.setItem('stats_duration', this.state.totalDuration);
                    localStorage.setItem('stats_presets', JSON.stringify(this.state.presetStats));
                }

                update(key, value) {
                    this.state[key] = value;
                }
                
                incrementPresetStat(name) {
                    if (!this.state.presetStats[name]) this.state.presetStats[name] = 0;
                    this.state.presetStats[name]++;
                    this.saveStats();
                }
            }

            // API Service
            const Api = {
                async get(url) {
                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('Network response was not ok');
                        return await res.json();
                    } catch (e) {
                        console.warn(`API Error (${url}):`, e);
                        throw e; // Propagate or handle?
                    }
                },
                async post(url, params = {}) {
                    // Assuming GET with query params based on original code, though POST is semantically better.
                    // Keeping original query param style for compatibility.
                    const query = new URLSearchParams(params).toString();
                    try {
                        await fetch(`${url}?${query}`);
                    } catch (e) {
                        console.warn(`API Error (${url}):`, e);
                    }
                }
            };

            // UI Controller
            class UI {
                constructor(store) {
                    this.store = store;
                    this.timer = null;
                    this.startTime = 0;
                    this.elements = this.cacheElements();
                    this.init();
                }

                cacheElements() {
                    return {
                        toastContainer: document.getElementById('toast-container'),
                        navItems: document.querySelectorAll('.nav-item'),
                        views: document.querySelectorAll('.view-section'),
                        // Inputs
                        inputAngle: document.getElementById('input-angle'),
                        inputTime: document.getElementById('input-time'),
                        inputLimit: document.getElementById('input-limit'),
                        inputSpeed: document.getElementById('input-speed'),
                        inputDebug: document.getElementById('input-debug'),
                        selectLang: document.getElementById('select-lang'),
                        // Labels
                        valAngle: document.getElementById('val-angle'),
                        valTime: document.getElementById('val-time'),
                        valLimit: document.getElementById('val-limit'),
                        valSpeed: document.getElementById('val-speed'),
                        valDebug: document.getElementById('val-debug'),
                        deviceName: document.getElementById('device-name'),
                        deviceCount: document.getElementById('device-count'),
                        yourDevice: document.getElementById('your-device'),
                        deviceListWrapper: document.getElementById('device-list-wrapper'),
                        deviceList: document.getElementById('device-list'),
                        // Overlays
                        overlayActive: document.getElementById('overlay-active'),
                        overlayResult: document.getElementById('overlay-result'),
                        activePresetName: document.getElementById('active-preset-name'),
                        pauseBtn: document.getElementById('btn-pause'),
                        stopBtn: document.getElementById('btn-stop'),
                        // Stats
                        statTotal: document.getElementById('stat-total'),
                        statAvg: document.getElementById('stat-avg'),
                        historyList: document.getElementById('history-list'),
                        // Result
                        resType: document.getElementById('res-type'),
                        resTime: document.getElementById('res-time')
                    };
                }

                init() {
                    this.applyLanguage(this.store.state.lang);
                    this.updateStats();
                    this.bindEvents();
                    this.startStatusPolling();
                    this.detectDevice();
                    this.initCharts();
                }

                initCharts() {
                    const ctxWeekly = document.getElementById('chart-weekly');
                    const ctxPreset = document.getElementById('chart-preset');

                    if (ctxWeekly) {
                        new Chart(ctxWeekly, {
                            type: 'bar',
                            data: {
                                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                                datasets: [{
                                    label: 'Squeezes',
                                    data: [12, 19, 3, 5, 2, 3, 10], // Mock Data
                                    backgroundColor: 'rgba(255, 75, 75, 0.6)',
                                    borderColor: 'rgba(255, 75, 75, 1)',
                                    borderWidth: 1,
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { display: false } },
                                scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                            }
                        });
                    }

                    if (ctxPreset) {
                        const s = this.store.state.presetStats;
                        this.presetChart = new Chart(ctxPreset, {
                            type: 'doughnut',
                            data: {
                                labels: ['Soft', 'Normal', 'Hard', 'Barikata', 'Custom'],
                                datasets: [{
                                    data: [s.soft, s.normal, s.hard, s.barikata, s.custom],
                                    backgroundColor: ['#FF9F43', '#FF4B4B', '#636e72', '#2d3436', '#34c759'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { position: 'right' } },
                                cutout: '70%'
                            }
                        });
                    }
                }

                updateCharts() {
                    if (this.presetChart) {
                        const s = this.store.state.presetStats;
                        this.presetChart.data.datasets[0].data = [s.soft, s.normal, s.hard, s.barikata, s.custom];
                        this.presetChart.update();
                    }
                }



                bindEvents() {
                    const s = this.store.state;

                    // Squeeze Button
                    document.getElementById('btn-squeeze').addEventListener('click', () => this.startSqueeze());

                    // Presets
                    document.querySelectorAll('#preset-list .btn').forEach(btn => {
                        btn.addEventListener('click', (e) => this.selectPreset(e.currentTarget));
                    });

                    // Inputs
                    this.elements.inputAngle.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value);
                        this.elements.valAngle.innerText = val + '°';
                        this.setCustomMode(val, null);
                    });
                    this.elements.inputTime.addEventListener('input', (e) => {
                        const val = parseFloat(e.target.value);
                        this.elements.valTime.innerText = val.toFixed(1) + 's';
                        this.setCustomMode(null, val);
                    });

                    // Settings Inputs
                    this.elements.inputLimit.addEventListener('input', (e) => {
                        const val = e.target.value;
                        this.elements.valLimit.innerText = val + '°';
                        this.store.update('minLimit', val);
                    });
                    this.elements.inputSpeed.addEventListener('input', (e) => {
                        const val = e.target.value;
                        this.elements.valSpeed.innerText = val + 's';
                        this.store.update('returnSpeed', val);
                    });
                    this.elements.inputDebug.addEventListener('input', (e) => {
                        const val = e.target.value;
                        this.elements.valDebug.innerText = val + '°';
                        Api.post(CONFIG.api.debug, { angle: val });
                    });
                    this.elements.selectLang.addEventListener('change', (e) => {
                        this.changeLanguage(e.target.value);
                    });

                    // Action Buttons
                    document.getElementById('btn-save-settings').addEventListener('click', () => {
                        this.vibrate(50);
                        this.saveSettings();
                    });
                    document.getElementById('btn-result-ok').addEventListener('click', () => {
                        this.vibrate(50);
                        this.elements.overlayResult.classList.remove('visible');
                    });
                    this.elements.pauseBtn.addEventListener('click', () => {
                        this.vibrate(50);
                        this.togglePause();
                    });
                    this.elements.stopBtn.addEventListener('click', () => {
                        this.vibrate(50);
                        this.stopSqueeze();
                    });

                    // Navigation
                    this.elements.navItems.forEach(item => {
                        item.addEventListener('click', () => {
                            this.vibrate(30);
                            this.switchTab(item);
                        });
                    });
                }

                applyLanguage(lang) {
                    this.store.update('lang', lang);
                    this.elements.selectLang.value = lang;
                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        const key = el.dataset.i18n;
                        if (TRANSLATIONS[lang][key]) el.innerText = TRANSLATIONS[lang][key];
                    });
                }

                changeLanguage(lang) {
                    localStorage.setItem('app_lang', lang);
                    this.applyLanguage(lang);
                    this.showToast(TRANSLATIONS[lang].msg_lang_ok);
                }

                selectPreset(btn) {
                    this.vibrate(40); // Preset click (No.1)
                    document.querySelectorAll('#preset-list .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const presetName = btn.dataset.preset;
                    this.store.update('activePresetName', presetName);

                    const p = CONFIG.presets[presetName];
                    this.store.update('angle', p.angle);
                    this.store.update('duration', p.duration);

                    this.updateSliders(p.angle, p.duration);
                }

                setCustomMode(angle, duration) {
                    document.querySelectorAll('#preset-list .btn').forEach(b => b.classList.remove('active'));
                    this.store.update('activePresetName', 'custom');
                    if (angle !== null) this.store.update('angle', angle);
                    if (duration !== null) this.store.update('duration', duration);
                }

                updateSliders(angle, duration) {
                    this.elements.inputAngle.value = angle;
                    this.elements.valAngle.innerText = angle + '°';
                    this.elements.inputTime.value = duration;
                    this.elements.valTime.innerText = duration.toFixed(1) + 's';
                }

                showToast(msg) {
                    const toast = document.createElement('div');
                    toast.className = 'toast';
                    toast.innerText = msg;
                    this.elements.toastContainer.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }

                switchTab(targetItem) {
                    const targetId = targetItem.dataset.target;
                    
                    // Determine direction
                    const tabs = Array.from(this.elements.navItems);
                    const oldIndex = tabs.findIndex(item => item.classList.contains('active'));
                    const newIndex = tabs.indexOf(targetItem);
                    const direction = newIndex > oldIndex ? 'forward' : 'backward';
                    document.documentElement.dataset.transition = direction;

                    // Support View Transitions API
                    if (!document.startViewTransition) {
                        this._updateDOM(targetItem, targetId);
                        return;
                    }

                    document.startViewTransition(() => {
                        this._updateDOM(targetItem, targetId);
                    });
                }

                _updateDOM(targetItem, targetId) {
                    this.elements.views.forEach(v => {
                        v.classList.add('hidden');
                        v.classList.remove('fade-in'); // Standard CSS fade removed in favor of VT
                    });

                    const targetView = document.getElementById(targetId);
                    targetView.classList.remove('hidden');
                    
                    this.elements.navItems.forEach(n => n.classList.remove('active'));
                    targetItem.classList.add('active');

                    if (targetId === 'view-settings') this.loadRemoteConfig();
                }

                async loadRemoteConfig() {
                    try {
                        const d = await Api.get(CONFIG.api.config);
                        if (d) {
                            this.store.update('minLimit', d.limit);
                            this.store.update('returnSpeed', d.speed);

                            this.elements.inputLimit.value = d.limit;
                            this.elements.valLimit.innerText = d.limit + '°';

                            this.elements.inputSpeed.value = d.speed;
                            this.elements.valSpeed.innerText = d.speed + 's';
                        }
                    } catch (e) { }
                }

                saveSettings() {
                    Api.post(CONFIG.api.save, {
                        limit: this.store.state.minLimit,
                        speed: this.store.state.returnSpeed
                    });
                    this.showToast(TRANSLATIONS[this.store.state.lang].msg_save_ok);
                }

                startSqueeze() {
                    const s = this.store.state;
                    if (s.isSqueezing) return;

                    this.store.update('isSqueezing', true);
                    this.store.update('isPaused', false);

                    const lang = s.lang;
                    const presetLabel = TRANSLATIONS[lang][`pst_${s.activePresetName}`] || TRANSLATIONS[lang].pst_custom;
                    this.elements.activePresetName.innerText = presetLabel.toUpperCase();

                    const btn = document.getElementById('btn-squeeze');
                    btn.classList.add('animate');
                    setTimeout(() => btn.classList.remove('animate'), 500);

                    // Call API
                    Api.post(CONFIG.api.squeeze, { angle: s.angle, duration: s.duration })
                        .catch(() => this.showToast("Connection limited"));
                    
                    this.vibrate(100); // Start vibration (No.1)

                    this.elements.overlayActive.classList.add('visible');
                    this.startTime = performance.now();
                    this.runTimer();
                }

                runTimer() {
                    const circle = document.getElementById('progress-ring-circle');
                    const cur = document.getElementById('timer-current');
                    const radius = circle.r.baseVal.value;
                    const circumference = radius * 2 * Math.PI;

                    circle.style.strokeDasharray = `${circumference} ${circumference}`;
                    circle.style.strokeDashoffset = circumference;

                    const durMs = this.store.state.duration * 1000;

                    if (this.timer) clearInterval(this.timer);

                    this.timer = setInterval(() => {
                        if (this.store.state.isPaused) {
                            this.startTime += 50;
                            return;
                        }
                        const elapsed = performance.now() - this.startTime;
                        const prog = Math.min(elapsed / durMs, 1);

                        cur.innerText = (elapsed / 1000).toFixed(1);
                        const offset = circumference - (prog * circumference);
                        circle.style.strokeDashoffset = offset;

                        if (prog >= 1) {
                            clearInterval(this.timer);
                            setTimeout(() => this.finish(), 800);
                        }
                    }, 50);
                }

                togglePause() {
                    const s = this.store.state;
                    const t = TRANSLATIONS[s.lang];

                    if (s.isPaused) {
                        this.store.update('isPaused', false);
                        this.startTime += (performance.now() - s.pausedAt);
                        const remain = Math.max(0, s.duration - (performance.now() - this.startTime) / 1000);

                        Api.post(CONFIG.api.squeeze, { angle: s.angle, duration: remain.toFixed(2) });
                        this.elements.pauseBtn.innerText = t.btn_pause;
                    } else {
                        this.store.update('isPaused', true);
                        this.store.update('pausedAt', performance.now());

                        Api.post(CONFIG.api.stop);
                        this.elements.pauseBtn.innerText = t.btn_resume || '再開';
                    }
                }

                stopSqueeze() {
                    clearInterval(this.timer);
                    this.store.update('isSqueezing', false);
                    Api.post(CONFIG.api.stop);
                    this.elements.overlayActive.classList.remove('visible');
                    this.showToast(TRANSLATIONS[this.store.state.lang].msg_stop_ok);
                }

                finish() {
                    const s = this.store.state;
                    this.store.update('isSqueezing', false);
                    this.store.update('count', s.count + 1);
                    this.store.update('totalDuration', s.totalDuration + s.duration);
                    
                    // Update Preset Stats (No.9)
                    const statName = CONFIG.presets[s.activePresetName] ? s.activePresetName : 'custom';
                    this.store.incrementPresetStat(statName);

                    this.store.saveStats();
                    this.updateStats();
                    this.updateCharts();

                    const type = TRANSLATIONS[s.lang][`pst_${s.activePresetName}`] || TRANSLATIONS[s.lang].pst_custom;
                    this.elements.resType.innerText = type;
                    this.elements.resTime.innerText = s.duration.toFixed(1) + 's';

                    // Prevent home screen flash by keeping active overlay visible until result fades in
                    this.elements.overlayResult.classList.add('visible');
                    setTimeout(() => {
                        this.elements.overlayActive.classList.remove('visible');
                    }, 400);

                    this.addToHistory(type);
                    this.triggerConfetti();
                    
                    this.vibrate([100, 50, 100]); // Completion vibration (No.1)
                }

                triggerConfetti() {
                    const container = document.getElementById('confetti-container');
                    container.innerHTML = '';
                    const colors = ['#FF4B4B', '#FF9F43', '#34c759', '#2d3436', '#ffcc00'];
                    
                    for (let i = 0; i < 50; i++) {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                        confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                        container.appendChild(confetti);
                    }
                }

                addToHistory(name) {
                    const li = document.createElement('li');
                    li.style.cssText = 'padding:10px; border-bottom:1px solid #efeff4; font-size:0.9rem';
                    li.innerText = `${new Date().toLocaleTimeString()} - ${name}`;
                    this.elements.historyList.prepend(li);
                }

                updateStats() {
                    const s = this.store.state;
                    this.elements.statTotal.innerText = s.count;
                    const avg = s.count > 0 ? (s.totalDuration / s.count).toFixed(1) : '0.0';
                    this.elements.statAvg.innerHTML = `${avg}<small style="font-size:0.8rem">s</small>`;
                }

                startStatusPolling() {
                    const update = async () => {
                        try {
                            const d = await Api.get(CONFIG.api.status);
                            this.elements.deviceCount.innerText = d.clients;
                            if (d.name) this.elements.deviceName.innerText = d.name;

                            if (d.devices && d.devices.length > 0) {
                                this.elements.deviceListWrapper.style.display = 'block';
                                this.elements.deviceList.innerHTML = d.devices
                                    .map(name => `<span style="background:var(--surface-light); padding:2px 8px; border-radius:10px; font-size:0.7rem">${name}</span>`)
                                    .join('');
                            }
                        } catch (e) { }
                    };
                    update();
                    setInterval(update, CONFIG.updateInterval);
                }

                detectDevice() {
                    const ua = navigator.userAgent;
                    let model = "Unknown Device";
                    // Simple detection logic
                    if (/iPhone/.test(ua)) model = "iPhone";
                    else if (/Android/.test(ua)) model = "Android Device";
                    else if (/Windows/.test(ua)) model = "Windows PC";
                    else if (/Macintosh/.test(ua)) model = "Mac";

                    this.elements.yourDevice.innerText = model;
                    Api.post(CONFIG.api.register, { name: model });
                }

                // Haptic Feedback Helper (No.1)
                vibrate(pattern) {
                    if (navigator.vibrate) {
                        navigator.vibrate(pattern);
                    }
                }
            }

            // Initialize App
            document.addEventListener('DOMContentLoaded', () => {
                const store = new Store();
                new UI(store);
            });
        })();
    </script>
</body>

</html>