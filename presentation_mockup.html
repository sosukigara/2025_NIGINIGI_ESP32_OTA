<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onigiri Journal - Smartphone Mockup</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #e0e0e0;
      background-image: radial-gradient(#ccc 1px, transparent 1px);
      background-size: 20px 20px;
      font-family: sans-serif;
    }

    /* スマホの筐体デザイン */
    .phone-frame {
      position: relative;
      width: 375px;
      height: 812px;
      /* iPhone X/12/13 mini サイズ比 */
      background: #000;
      border-radius: 50px;
      box-shadow:
        0 0 0 2px #333,
        0 20px 50px rgba(0, 0, 0, 0.5);
      border: 12px solid #1c1c1e;
      overflow: hidden;

      /* レスポンシブ対応 */
      max-width: 90vw;
      max-height: 85vh;
      aspect-ratio: 9 / 19.5;
    }

    .notch {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 28px;
      background: #1c1c1e;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
      z-index: 100;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
      display: block;
    }

    .caption {
      margin-top: 20px;
      color: #666;
      font-size: 0.8rem;
    }
  </style>
</head>

<body>

  <!-- スマホの枠 -->
  <div class="phone-frame">
    <div class="notch"></div>
    <iframe id="app-screen"></iframe>
  </div>

  <div class="caption">※ PCブラウザでの表示イメージです</div>

  <!-- 
    【修正ポイント】
    アプリのコードを textarea に入れることで、
    ブラウザが勝手にタグを解釈して画面が崩れるのを防ぎます。
    この textarea は display:none で隠れています。
  -->
  <textarea id="app-source-code" style="display:none;">
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Onigiri Journal (Mockup)</title>
<style>
:root {
  --bg: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-sub: #8e8e93;
  --accent-purple: #1a7f37; --accent-blue: #2ea043; --danger: #ff3b30; --yt-red: #ff0000; --success: #2ea043;
  --shadow: 0 4px 12px rgba(0,0,0,0.03); --radius: 16px;
}
* { -webkit-tap-highlight-color: transparent; user-select: none; -webkit-touch-callout: none; box-sizing: border-box; }
body { background: var(--bg); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; height: 100dvh; width: 100vw; overflow: hidden; }

/* UI Styles */
.header { margin-bottom: 12px; padding-top: 0; display: flex; justify-content: space-between; align-items: center; } 
.header h1 { font-size: clamp(1.5rem, 5vw, 1.9rem); font-weight: 800; margin: 0; letter-spacing: -0.02em; }
.header-actions { display: flex; gap: 8px; }
.btn-icon { background: none; border: none; padding: 8px; color: var(--text-main); cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.btn-icon:active { background: rgba(0,0,0,0.05); }

.conn-dot { width: 10px; height: 10px; background: var(--success); border-radius: 50%; margin-right: 8px; transition: background 0.3s; }
.offline .conn-dot { background: var(--danger); }

#view-main, #view-settings, #view-history { display: flex; flex-direction: column; height: 100dvh; padding-top: max(20px, env(safe-area-inset-top)); padding-bottom: max(20px, env(safe-area-inset-bottom)); padding-left: max(20px, env(safe-area-inset-left)); padding-right: max(20px, env(safe-area-inset-right)); box-sizing: border-box; }

.card { background: var(--card-bg); border-radius: var(--radius); padding: clamp(12px, 2vh, 20px); margin-bottom: 2vh; box-shadow: var(--shadow); overflow: hidden; flex-shrink: 1; }
.card-monitor { display: flex; flex-direction: column; position: relative; padding-bottom: 2vh; flex-grow: 2; justify-content: center; }
.monitor-row { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; margin-bottom: 12px; }
.status-badge { background: #f2f2f7; color: var(--text-sub); padding: 6px 14px; border-radius: 24px; font-size: 0.9rem; font-weight: 700; transition: 0.3s; }
.running .status-badge { background: #fee2e2; color: var(--yt-red); }

.time-big { font-size: clamp(4.0rem, 18vw, 5.5rem); font-weight: 800; font-variant-numeric: tabular-nums; letter-spacing: -2px; line-height: 1; opacity: 0; transition: opacity 0.3s; }
body.ready .time-big { opacity: 1; }

.yt-progress-container { width: 100%; height: 8px; background: #e5e5ea; position: relative; border-radius: 4px; overflow: hidden; }
.yt-progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--yt-red); border-radius: 4px; width: 0%; }

.card-preset h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; }
.preset-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.preset-btn { background: var(--bg); border: 2px solid transparent; padding: 22px 4px; border-radius: 14px; font-size: 0.95rem; font-weight: 700; color: var(--text-main); text-align: center; cursor: pointer; transition: 0.2s; white-space: nowrap; }
.preset-btn:active { transform: scale(0.98); }
.preset-btn.active { background: #fff; border-color: var(--accent-blue); color: var(--accent-blue); box-shadow: 0 4px 10px rgba(0,122,255,0.15); }

.card-settings { padding: 18px; } 
.setting-item { padding: 10px 0; display: flex; flex-direction: column; border-bottom: 1px solid #f2f2f7; }
.setting-item:last-child { border-bottom: none; }
.s-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.s-label { font-size: 1rem; font-weight: 700; color: var(--text-main); }
.s-val { font-size: 1.1rem; font-weight: 700; color: var(--accent-purple); font-variant-numeric: tabular-nums; }

input[type=range] { -webkit-appearance: none; width: 100%; height: 44px; background: transparent; cursor: pointer; margin: 0; }
input[type=range]:focus { outline: none; }
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 14px; background: #e5e5ea; border-radius: 7px; }
#inp-str::-webkit-slider-runnable-track { background: linear-gradient(90deg, #e5e5ea 0%, #56d364 50%, #1a7f37 100%); }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 32px; width: 32px; border-radius: 50%; background: #ffffff; border: 0.5px solid rgba(0,0,0,0.04); box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin-top: -9px; transition: transform 0.1s; }
input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); background: #f2f2f7; }

.chk-group { display: flex; gap: 10px; justify-content: flex-end; }
.chk-btn { width: 48px; height: 48px; border-radius: 50%; background: #f2f2f7; color: var(--text-sub); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
.chk-btn.active { background: var(--accent-blue); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(1.05); }

.history-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f2f2f7; }
.history-row:last-child { border-bottom: none; }
.h-info { display: flex; flex-direction: column; gap: 2px; }
.h-preset { font-weight: 700; font-size: 1rem; color: var(--text-main); }
.h-detail { font-size: 0.85rem; color: var(--text-sub); }
.h-time { font-family: monospace; font-size: 0.9rem; color: var(--accent-purple); font-weight: 600; }

.bottom-bar { margin-top: auto; display: flex; gap: 12px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); flex-shrink: 0; }
.action-btn { flex: 1; height: 68px; border-radius: 34px; border: none; font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; box-shadow: inset 0 1px 1px rgba(255,255,255,0.4); transition: transform 0.1s; }
.action-btn:active { transform: scale(0.98); }
.btn-start { background: var(--accent-blue); color: white; }
.btn-stop { background: var(--danger); color: white; display: none; }
.running .btn-start { display: none; }
.running .btn-stop { display: flex; }

.switch { position: relative; display: inline-block; width: 50px; height: 28px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e5ea; transition: .4s; border-radius: 28px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
input:checked + .slider { background-color: var(--accent-blue); }
input:checked + .slider:before { transform: translateX(22px); }

.completion-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s; }
.completion-modal.show { display: flex; }
.completion-content { background: var(--card-bg); border-radius: 28px; padding: 32px 28px; text-align: center; max-width: 85%; width: min(340px, 90vw); box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
.completion-title { font-size: 1.6rem; font-weight: 800; color: var(--text-main); margin-bottom: 24px; }
.completion-details { text-align: left; background: var(--bg); padding: 16px 20px; border-radius: 16px; margin-bottom: 24px; }
.detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
.detail-row:last-child { border-bottom: none; }
.detail-label { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; }
.detail-value { font-size: 1.0rem; color: var(--text-main); font-weight: 700; }
.completion-btn { background: var(--text-main); color: white; border: none; padding: 16px 32px; border-radius: 30px; font-size: 1.0rem; font-weight: 700; cursor: pointer; transition: transform 0.2s; width: 100%; }
.completion-btn:active { transform: scale(0.96); opacity: 0.9; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes scaleIn { from { transform: scale(0.9); opacity: 1; } to { transform: scale(1); opacity: 1; } }
@media (max-height: 750px) { .header { margin-bottom: 10px; } .card { margin-bottom: 10px; } .time-big { font-size: 3.5rem; } .status-badge { font-size: 0.8rem; padding: 4px 10px; } .action-btn { height: 56px; font-size: 1.1rem; } }
</style>
</head>
<body>

<div id="view-main">
  <div class="header">
    <div style="display:flex; align-items:center;">
      <div class="conn-dot" id="conn-dot"></div>
      <div style="display:flex; flex-direction:column;">
        <h1 style="line-height:1;">にぎにぎ</h1>
        <span style="font-size:0.75rem; color:var(--text-sub); font-family:monospace;">v1.41.1 (Mock)</span>
      </div>
    </div>
    <div class="header-actions">
        <button class="btn-icon" onclick="showHistory()" style="font-weight:700; padding:8px 12px; border:1px solid #ddd; border-radius:12px; background:#f5f5f5;">履歴</button>
        <button class="btn-icon" onclick="showSettings()" style="font-weight:700; padding:8px 12px; border:1px solid #ddd; border-radius:12px; background:#f5f5f5;">設定</button>
    </div>
  </div>

  <div class="card card-monitor">
    <div class="monitor-row">
      <div class="status-badge" id="status-badge">待機中</div>
      <div class="time-big" id="time-display">--:--</div>
    </div>
    <div class="yt-progress-container">
      <div class="yt-progress-fill" id="yt-fill"></div>
    </div>
  </div>

  <div class="card card-preset">
    <h3>プリセット</h3>
    <div class="preset-grid" style="grid-template-columns: 1fr 1fr 1fr;">
      <div class="preset-btn" onclick="setPreset('soft',this)" data-name="やわらか">やわらか</div>
      <div class="preset-btn active" onclick="setPreset('normal',this)" data-name="ふつう">ふつう</div>
      <div class="preset-btn" onclick="setPreset('kosen',this)" data-name="高専生用">高専生用</div>
    </div>
  </div>

  <div class="card card-settings">
    <div class="setting-item">
      <div class="s-header"><span class="s-label">握りの強さ</span><span class="s-val" id="str-disp">50%</span></div>
      <input type="range" id="inp-str" min="0" max="100" value="50" oninput="updVal('str-disp', this.value, '%')">
    </div>
    <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between; padding:16px 0;">
      <span class="s-label">回数</span>
      <div class="chk-group">
        <div class="chk-btn" onclick="setCount(1,this)">1</div>
        <div class="chk-btn" onclick="setCount(2,this)">2</div>
        <div class="chk-btn active" onclick="setCount(3,this)">3</div>
        <div class="chk-btn" onclick="setCount(4,this)">4</div>
        <div class="chk-btn" onclick="setCount(5,this)">5</div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <button class="action-btn btn-start" onclick="start()">開始</button>
    <button class="action-btn btn-stop" onclick="stop()">停止</button>
  </div>
</div>

<div id="view-settings" style="display:none; padding-bottom:40px;">
  <div class="header" style="display:flex; align-items:center; gap:10px;">
    <button onclick="showMain()" style="background:none; border:none; color:var(--text-main); cursor:pointer; padding:0; font-size:2rem; font-weight:bold;">←</button>
    <h1>詳細設定</h1>
  </div>
  <div class="card card-settings">
    <div class="setting-item">
      <span class="s-label">システム情報</span>
      <div style="margin-top:8px; font-size:0.9rem; color:var(--text-sub);">
        <div>Version: <span style="font-family:monospace;">1.41.1 (Mock)</span></div>
        <div>Build: <span style="font-family:monospace;">MOCK_BUILD</span></div>
        <div>IP: <span style="font-family:monospace;" id="ip-disp">192.168.4.1</span></div>
      </div>
    </div>
    <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between;">
      <span class="s-label">保持時間 (秒)</span>
      <input type="number" id="inp-hold" value="0.5" step="0.1" style="width:80px; padding:12px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:1.1rem; font-weight:700;" onchange="saveHold(this.value)">
    </div>
    <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between;">
      <span class="s-label">到達時間 (秒)</span>
      <input type="number" id="inp-reach" value="0.5" step="0.1" style="width:80px; padding:12px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:1.1rem; font-weight:700;" onchange="saveReach(this.value)">
    </div>
    <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between;">
      <span class="s-label">外部出力 (Pin 13)</span>
      <label class="switch"><input type="checkbox" id="chk-pin13" onchange="togglePin13(this)"><span class="slider round"></span></label>
    </div>
    <div class="setting-item">
      <div class="s-header"><span class="s-label">全サーボ同時調整 (90-270度)</span><span class="s-val" id="all-servo-val">270°</span></div>
      <input type="range" min="90" max="270" value="270" step="1" oninput="setAllServos(this.value)" style="width:100%;">
    </div>
    <div class="setting-item">
      <div class="s-header"><span class="s-label">サーボ1 (GPIO 18)</span><span class="s-val" id="servo1-val">270°</span></div>
      <input type="range" min="90" max="270" value="270" step="1" oninput="setServo(1, this.value)" style="width:100%;">
    </div>
    <div class="setting-item">
      <div class="s-header"><span class="s-label">サーボ2 (GPIO 26)</span><span class="s-val" id="servo2-val">270°</span></div>
      <input type="range" min="90" max="270" value="270" step="1" oninput="setServo(2, this.value)" style="width:100%;">
    </div>
    <div class="setting-item">
      <div class="s-header"><span class="s-label">サーボ3 (GPIO 27)</span><span class="s-val" id="servo3-val">270°</span></div>
      <input type="range" min="90" max="270" value="270" step="1" oninput="setServo(3, this.value)" style="width:100%;">
    </div>
  </div>
</div>

<div id="view-history" style="display:none; padding-bottom:40px;">
  <div class="header" style="display:flex; align-items:center; gap:10px;">
    <button onclick="showMain()" style="background:none; border:none; color:var(--text-main); cursor:pointer; padding:0; font-size:2rem; font-weight:bold;">←</button>
    <h1>履歴</h1>
  </div>
  <div id="history-list" class="card" style="padding:10px 20px;"></div>
</div>

<div class="completion-modal" id="completion-modal">
  <div class="completion-content">
    <div class="completion-title">完成！</div>
    <div class="completion-details">
      <div class="detail-row"><span class="detail-label">プリセット</span><span class="detail-value" id="detail-preset">-</span></div>
      <div class="detail-row"><span class="detail-label">強さ</span><span class="detail-value" id="detail-strength">-</span></div>
      <div class="detail-row"><span class="detail-label">回数</span><span class="detail-value" id="detail-count">-</span></div>
    </div>
    <button class="completion-btn" onclick="closeCompletionModal()">OK</button>
  </div>
</div>

<script>
  let tgtCount = 3;
  let currentPresetName = "ふつう";
  let isRunning = false;
  let isManualStop = false;
  let sessionTotalDur = 0;
  let sessionStartTime = 0;
  let runPreset = "";
  let runStrength = 0;
  let runCount = 0;
  const mockHistory = [
    { time: "2026/01/20 08:30", preset: "ふつう", strength: 50, count: 3 },
    { time: "2026/01/20 08:15", preset: "高専生用", strength: 100, count: 5 },
    { time: "2026/01/19 22:45", preset: "やわらか", strength: 30, count: 2 }
  ];

  document.addEventListener('DOMContentLoaded', () => { fetchSettings(); });

  function fetchSettings() { updTimeDisp(); setTimeout(() => document.body.classList.add('ready'), 100); }
  function saveHold(v) { console.log("Set Hold:", v); updTimeDisp(); }
  function saveReach(v) { console.log("Set Reach:", v); updTimeDisp(); }
  function togglePin13(el) { console.log("Pin 13:", el.checked); }
  function updVal(id, v, unit) { document.getElementById(id).innerText = v + unit; }
  function fmtTime(s) { let min = Math.floor(s / 60); let sec = Math.floor(s % 60); return min + ":" + (sec < 10 ? "0" : "") + sec; }
  function updTimeDisp() {
    if (isRunning) return;
    const h = parseFloat(document.getElementById('inp-hold').value) || 0.5;
    const r = parseFloat(document.getElementById('inp-reach').value) || 0.5;
    const total = tgtCount * (h + r + 0.3);
    document.getElementById('time-display').innerText = fmtTime(Math.ceil(total));
  }
  function setCount(n, el) {
    tgtCount = n;
    document.querySelectorAll('.chk-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    if (!isRunning) updTimeDisp();
  }
  function setPreset(mode, el) {
    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentPresetName = el.getAttribute('data-name');
    const s = document.getElementById('inp-str');
    let count = 3;
    if (mode === 'soft') { s.value = 30; count = 2; }
    if (mode === 'normal') { s.value = 50; count = 3; }
    if (mode === 'kosen') { s.value = 100; count = 5; }
    updVal('str-disp', s.value, '%');
    tgtCount = count;
    document.querySelectorAll('.chk-btn').forEach(b => { if (parseInt(b.innerText) === count) { b.classList.add('active'); } else { b.classList.remove('active'); } });
    if (!isRunning) updTimeDisp();
  }
  function showSettings() { document.getElementById('view-main').style.display = 'none'; document.getElementById('view-settings').style.display = 'block'; document.getElementById('view-history').style.display = 'none'; }
  function showHistory() { document.getElementById('view-main').style.display = 'none'; document.getElementById('view-settings').style.display = 'none'; document.getElementById('view-history').style.display = 'block'; fetchHistory(); }
  function showMain() { document.getElementById('view-settings').style.display = 'none'; document.getElementById('view-history').style.display = 'none'; document.getElementById('view-main').style.display = 'block'; }
  function fetchHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = "";
    if (mockHistory.length === 0) { list.innerHTML = "<div style='padding:20px; text-align:center; color:#888;'>履歴はありません</div>"; return; }
    mockHistory.forEach(item => {
      const row = document.createElement('div');
      row.className = 'history-row';
      row.innerHTML =
        '<div class="h-info">' +
        '<span class="h-preset">' + item.preset + '</span>' +
        '<div class="h-detail">強さ:' + item.strength + '% / ' + item.count + '回</div>' +
        '</div>' +
        '<div class="h-time">' + item.time + '</div>';
      list.appendChild(row);
    });
  }
  function start() {
    const s = document.getElementById('inp-str').value;
    isManualStop = false; isRunning = true;
    document.body.classList.add('running');
    document.getElementById('status-badge').innerText = "準備中...";
    sessionStartTime = Date.now();
    runPreset = currentPresetName; runStrength = s; runCount = tgtCount;
    const h = parseFloat(document.getElementById('inp-hold').value) || 0.5;
    const r = parseFloat(document.getElementById('inp-reach').value) || 0.5;
    sessionTotalDur = tgtCount * (h + r + 0.3);
    if (sessionTotalDur < 1) sessionTotalDur = 1;
    console.log("Start");
  }
  function stop() { isManualStop = true; finishSession(); }
  function animateLoop() {
    if (isRunning && sessionTotalDur > 0) {
      const now = Date.now();
      const elapsedSec = (now - sessionStartTime) / 1000;
      const remaining = Math.max(0, sessionTotalDur - elapsedSec);
      document.getElementById('time-display').innerText = fmtTime(Math.ceil(remaining));
      if (elapsedSec < 1) document.getElementById('status-badge').innerText = "準備中...";
      else if (elapsedSec < sessionTotalDur) {
        const cycleDur = sessionTotalDur / tgtCount;
        const currentCycle = Math.min(tgtCount, Math.ceil(elapsedSec / cycleDur));
        const phase = Math.floor(elapsedSec * 2) % 2;
        const txt = phase === 0 ? "握り中" : "保持中";
        document.getElementById('status-badge').innerText = txt + " (" + currentCycle + "/" + tgtCount + ")";
      }
      let pct = (elapsedSec / sessionTotalDur) * 100;
      if (pct < 0) pct = 0; if (pct > 100) pct = 100;
      document.getElementById('yt-fill').style.width = pct + "%";
      if (remaining <= 0 && !isManualStop) {
        finishSession();
        const d = new Date();
        const timeStr = d.getFullYear() + "/" + (d.getMonth() + 1).toString().padStart(2, '0') + "/" + d.getDate().toString().padStart(2, '0') + " " + d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
        mockHistory.unshift({ time: timeStr, preset: runPreset, strength: runStrength, count: runCount });
      }
    }
    requestAnimationFrame(animateLoop);
  }
  requestAnimationFrame(animateLoop);
  function finishSession() {
    isRunning = false;
    document.body.classList.remove('running');
    document.getElementById('status-badge').innerText = "待機中";
    document.getElementById('yt-fill').style.width = '0%';
    updTimeDisp();
    if (!isManualStop) { showCompletionModal(); }
    isManualStop = false;
  }
  function showCompletionModal() {
    const modal = document.getElementById('completion-modal');
    document.getElementById('detail-preset').innerText = runPreset;
    document.getElementById('detail-strength').innerText = runStrength + '%';
    document.getElementById('detail-count').innerText = runCount + '回';
    modal.classList.add('show');
  }
  function closeCompletionModal() { document.getElementById('completion-modal').classList.remove('show'); }
  function setAllServos(angle) {
    document.getElementById('all-servo-val').innerText = angle + '°';
    document.getElementById('servo1-val').innerText = angle + '°';
    document.getElementById('servo2-val').innerText = angle + '°';
    document.getElementById('servo3-val').innerText = angle + '°';
  }
  function setServo(servoNum, angle) { document.getElementById('servo' + servoNum + '-val').innerText = angle + '°'; }
</script>
</body>
</html>
  </textarea>

  <script>
    // 隠しテキストエリアからアプリのコードを取得して iframe に流し込む
    // この方法なら、コード内の <script> タグが親ページに干渉しません
    const iframe = document.getElementById('app-screen');
    const sourceCode = document.getElementById('app-source-code').value;
    iframe.srcdoc = sourceCode;
  </script>

</body>

</html>