<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onigiri Journal - Smartphone Mockup</title>

  <!-- 1. Web„Éï„Ç©„É≥„Éà„ÅÆÂ∞éÂÖ•ÔºàÂ¥©„ÇåÈò≤Ê≠¢„Éª„Éá„Ç∂„Ç§„É≥Áµ±‰∏ÄÔºâ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+JP:wght@400;700;900&display=swap"
    rel="stylesheet">

  <!-- „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÁîüÊàêÁî®„É©„Ç§„Éñ„É©„É™ -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    /* --- BASE STYLES --- */
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #e0e0e0;
      background-image: radial-gradient(#ccc 1px, transparent 1px);
      background-size: 20px 20px;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      /* „Éï„Ç©„É≥„ÉàÊåáÂÆö */
      gap: 20px;
    }

    /* „Çπ„Éû„Éõ„ÅÆÊû† */
    .phone-frame {
      position: relative;
      width: 375px;
      height: 812px;
      background: #000;
      border-radius: 50px;
      box-shadow:
        0 0 0 2px #333,
        0 20px 50px rgba(0, 0, 0, 0.5);
      border: 12px solid #1c1c1e;
      overflow: hidden;
      /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
      max-width: 90vw;
      max-height: 85vh;
      aspect-ratio: 9 / 19.5;
      flex-shrink: 0;
      /* html2canvasÁî®„ÅÆ„Åä„Åæ„Åò„Å™„ÅÑÔºàÊñáÂ≠ó„ÅÆÊª≤„ÅøÈò≤Ê≠¢Ôºâ */
      letter-spacing: normal;
    }

    /* „Éé„ÉÉ„ÉÅ */
    .notch {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 30px;
      background: #1c1c1e;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
      z-index: 9999;
    }

    /* ÊíÆÂΩ±„Éú„Çø„É≥ */
    .capture-btn {
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: bold;
      color: white;
      background: #333;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.1s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Noto Sans JP', sans-serif;
    }

    .capture-btn:active {
      transform: scale(0.96);
    }

    .capture-btn::before {
      content: "üì∑";
    }

    /* --- APP STYLES --- */
    #app-screen {
      width: 100%;
      height: 100%;
      background: #f2f2f7;
      color: #1c1c1e;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      /* „Ç¢„Éó„É™ÂÜÖ„ÇÇÁµ±‰∏Ä */
      overflow: hidden;
      position: relative;
      border-radius: 38px;

      /* CSSÂ§âÊï∞ÂÆöÁæ© */
      --bg: #f2f2f7;
      --card-bg: #ffffff;
      --text-main: #1c1c1e;
      --text-sub: #8e8e93;
      --accent-purple: #1a7f37;
      --accent-blue: #2ea043;
      --danger: #ff3b30;
      --yt-red: #ff0000;
      --success: #2ea043;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      --radius: 16px;
    }

    #app-screen * {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-touch-callout: none;
      box-sizing: border-box;
    }

    #app-screen .view-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding-top: 55px;
      padding-bottom: 20px;
      padding-left: 20px;
      padding-right: 20px;
      box-sizing: border-box;
    }

    /* Header */
    #app-screen .header {
      margin-bottom: 12px;
      padding-top: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #app-screen .header h1 {
      font-size: 1.6rem;
      font-weight: 800;
      margin: 0;
      letter-spacing: -0.02em;
      font-family: 'Noto Sans JP', sans-serif;
    }

    #app-screen .header-actions {
      display: flex;
      gap: 8px;
    }

    #app-screen .btn-icon {
      background: none;
      border: none;
      padding: 8px;
      color: var(--text-main);
      cursor: pointer;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Noto Sans JP', sans-serif;
    }

    #app-screen .conn-dot {
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      margin-right: 8px;
      transition: background 0.3s;
    }

    /* Cards */
    #app-screen .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      flex-shrink: 1;
    }

    #app-screen .card-monitor {
      display: flex;
      flex-direction: column;
      position: relative;
      padding-bottom: 2vh;
      flex-grow: 2;
      justify-content: center;
    }

    #app-screen .monitor-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    #app-screen .status-badge {
      background: #f2f2f7;
      color: var(--text-sub);
      padding: 6px 14px;
      border-radius: 24px;
      font-size: 0.9rem;
      font-weight: 700;
      transition: 0.3s;
    }

    #app-screen.running .status-badge {
      background: #fee2e2;
      color: var(--yt-red);
    }

    #app-screen .time-big {
      font-size: 5.0rem;
      /* „Éï„Ç©„É≥„ÉàË™øÊï¥ */
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      letter-spacing: -1px;
      line-height: 1;
      opacity: 0;
      transition: opacity 0.3s;
      font-family: 'Inter', sans-serif;
      /* Êï∞Â≠ó„ÅØInter„Åß */
      transform: translateY(-5px);
      /* ÂæÆË™øÊï¥ */
    }

    #app-screen.ready .time-big {
      opacity: 1;
    }

    #app-screen .yt-progress-container {
      width: 100%;
      height: 8px;
      background: #e5e5ea;
      position: relative;
      border-radius: 4px;
      overflow: hidden;
    }

    #app-screen .yt-progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: var(--yt-red);
      border-radius: 4px;
      width: 0%;
    }

    #app-screen .card-preset h3 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      color: var(--text-sub);
      font-weight: 700;
    }

    #app-screen .preset-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    #app-screen .preset-btn {
      background: var(--bg);
      border: 2px solid transparent;
      padding: 22px 4px;
      border-radius: 14px;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-main);
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
      white-space: nowrap;
    }

    #app-screen .preset-btn.active {
      background: #fff;
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      box-shadow: 0 4px 10px rgba(0, 122, 255, 0.15);
    }

    #app-screen .card-settings {
      padding: 18px;
    }

    #app-screen .setting-item {
      padding: 10px 0;
      display: flex;
      flex-direction: column;
      border-bottom: 1px solid #f2f2f7;
    }

    #app-screen .setting-item:last-child {
      border-bottom: none;
    }

    #app-screen .s-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #app-screen .s-label {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-main);
    }

    #app-screen .s-val {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent-purple);
      font-variant-numeric: tabular-nums;
    }

    /* Sliders */
    #app-screen input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 44px;
      background: transparent;
      cursor: pointer;
      margin: 0;
    }

    #app-screen input[type=range]:focus {
      outline: none;
    }

    #app-screen input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 14px;
      background: #e5e5ea;
      border-radius: 7px;
    }

    #app-screen #inp-str::-webkit-slider-runnable-track {
      background: linear-gradient(90deg, #e5e5ea 0%, #56d364 50%, #1a7f37 100%);
    }

    #app-screen input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 32px;
      width: 32px;
      border-radius: 50%;
      background: #ffffff;
      border: 0.5px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      margin-top: -9px;
      transition: transform 0.1s;
    }

    #app-screen .chk-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    #app-screen .chk-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #f2f2f7;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: 0.2s;
      font-family: 'Inter', sans-serif;
    }

    #app-screen .chk-btn.active {
      background: var(--accent-blue);
      color: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transform: scale(1.05);
    }

    #app-screen .bottom-bar {
      margin-top: auto;
      display: flex;
      gap: 12px;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.1));
      flex-shrink: 0;
    }

    #app-screen .action-btn {
      flex: 1;
      height: 68px;
      border-radius: 34px;
      border: none;
      font-size: 1.2rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.4);
      transition: transform 0.1s;
    }

    #app-screen .action-btn:active {
      transform: scale(0.98);
    }

    #app-screen .btn-start {
      background: var(--accent-blue);
      color: white;
    }

    #app-screen .btn-stop {
      background: var(--danger);
      color: white;
      display: none;
    }

    #app-screen.running .btn-start {
      display: none;
    }

    #app-screen.running .btn-stop {
      display: flex;
    }

    #app-screen .history-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f2f2f7;
    }

    #app-screen .history-row:last-child {
      border-bottom: none;
    }

    #app-screen .h-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #app-screen .h-preset {
      font-weight: 700;
      font-size: 1rem;
      color: var(--text-main);
    }

    #app-screen .h-detail {
      font-size: 0.85rem;
      color: var(--text-sub);
    }

    #app-screen .h-time {
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--accent-purple);
      font-weight: 600;
    }

    #app-screen .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    #app-screen .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    #app-screen .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e5e5ea;
      transition: .4s;
      border-radius: 28px;
    }

    #app-screen .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #app-screen input:checked+.slider {
      background-color: var(--accent-blue);
    }

    #app-screen input:checked+.slider:before {
      transform: translateX(22px);
    }

    #app-screen .completion-modal {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #app-screen .completion-modal.show {
      display: flex;
    }

    #app-screen .completion-content {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 32px 28px;
      text-align: center;
      max-width: 85%;
      width: min(340px, 90vw);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    #app-screen .completion-title {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--text-main);
      margin-bottom: 24px;
    }

    #app-screen .completion-details {
      text-align: left;
      background: var(--bg);
      padding: 16px 20px;
      border-radius: 16px;
      margin-bottom: 24px;
    }

    #app-screen .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    #app-screen .detail-label {
      font-size: 0.9rem;
      color: var(--text-sub);
      font-weight: 600;
    }

    #app-screen .detail-value {
      font-size: 1.0rem;
      color: var(--text-main);
      font-weight: 700;
    }

    #app-screen .completion-btn {
      background: var(--text-main);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 30px;
      font-size: 1.0rem;
      font-weight: 700;
      width: 100%;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- 1. „Çπ„Éû„ÉõÊû† -->
  <div class="phone-frame" id="capture-target">
    <div class="notch"></div>

    <!-- 2. „Ç¢„Éó„É™ÁîªÈù¢ -->
    <div id="app-screen">

      <!-- VIEW: MAIN -->
      <div id="view-main" class="view-container">
        <div class="header">
          <div style="display:flex; align-items:center;">
            <div class="conn-dot" id="conn-dot"></div>
            <div style="display:flex; flex-direction:column;">
              <h1 style="line-height:1;">„Å´„Åé„Å´„Åé</h1>
              <span style="font-size:0.75rem; color:var(--text-sub); font-family:monospace;">v1.41.1 (Mock)</span>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn-icon" onclick="showHistory()"
              style="font-weight:700; padding:8px 12px; border:1px solid #ddd; border-radius:12px; background:#f5f5f5;">Â±•Ê≠¥</button>
            <button class="btn-icon" onclick="showSettings()"
              style="font-weight:700; padding:8px 12px; border:1px solid #ddd; border-radius:12px; background:#f5f5f5;">Ë®≠ÂÆö</button>
          </div>
        </div>

        <div class="card card-monitor">
          <div class="monitor-row">
            <div class="status-badge" id="status-badge">ÂæÖÊ©ü‰∏≠</div>
            <div class="time-big" id="time-display">--:--</div>
          </div>
          <div class="yt-progress-container">
            <div class="yt-progress-fill" id="yt-fill"></div>
          </div>
        </div>

        <div class="card card-preset">
          <h3>„Éó„É™„Çª„ÉÉ„Éà</h3>
          <div class="preset-grid" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="preset-btn" onclick="setPreset('soft',this)" data-name="„ÇÑ„Çè„Çâ„Åã">„ÇÑ„Çè„Çâ„Åã</div>
            <div class="preset-btn active" onclick="setPreset('normal',this)" data-name="„Åµ„Å§„ÅÜ">„Åµ„Å§„ÅÜ</div>
            <div class="preset-btn" onclick="setPreset('kosen',this)" data-name="È´òÂ∞ÇÁîüÁî®">È´òÂ∞ÇÁîüÁî®</div>
          </div>
        </div>

        <div class="card card-settings">
          <div class="setting-item">
            <div class="s-header"><span class="s-label">Êè°„Çä„ÅÆÂº∑„Åï</span><span class="s-val" id="str-disp">50%</span></div>
            <input type="range" id="inp-str" class="input-slider" min="0" max="100" value="50"
              oninput="updVal('str-disp', this.value, '%')">
          </div>
          <div class="setting-item"
            style="flex-direction:row; align-items:center; justify-content:space-between; padding:16px 0;">
            <span class="s-label">ÂõûÊï∞</span>
            <div class="chk-group">
              <div class="chk-btn" onclick="setCount(1,this)">1</div>
              <div class="chk-btn" onclick="setCount(2,this)">2</div>
              <div class="chk-btn active" onclick="setCount(3,this)">3</div>
              <div class="chk-btn" onclick="setCount(4,this)">4</div>
              <div class="chk-btn" onclick="setCount(5,this)">5</div>
            </div>
          </div>
        </div>

        <div class="bottom-bar">
          <button class="action-btn btn-start" onclick="start()">ÈñãÂßã</button>
          <button class="action-btn btn-stop" onclick="stop()">ÂÅúÊ≠¢</button>
        </div>
      </div>

      <!-- VIEW: SETTINGS -->
      <div id="view-settings" class="view-container" style="display:none;">
        <div class="header" style="display:flex; align-items:center; gap:10px;">
          <button onclick="showMain()"
            style="background:none; border:none; color:var(--text-main); cursor:pointer; padding:0; font-size:2rem; font-weight:bold;">‚Üê</button>
          <h1>Ë©≥Á¥∞Ë®≠ÂÆö</h1>
        </div>
        <div class="card card-settings">
          <div class="setting-item">
            <span class="s-label">„Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±</span>
            <div style="margin-top:8px; font-size:0.9rem; color:var(--text-sub);">
              <div>Version: <span style="font-family:monospace;">1.41.1 (Mock)</span></div>
              <div>Build: <span style="font-family:monospace;">MOCK_BUILD</span></div>
              <div>IP: <span style="font-family:monospace;" id="ip-disp">192.168.4.1</span></div>
            </div>
          </div>
          <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between;">
            <span class="s-label">‰øùÊåÅÊôÇÈñì (Áßí)</span>
            <input type="number" id="inp-hold" value="0.5" step="0.1"
              style="width:80px; padding:12px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:1.1rem; font-weight:700;"
              onchange="saveHold(this.value)">
          </div>
          <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between;">
            <span class="s-label">Âà∞ÈÅîÊôÇÈñì (Áßí)</span>
            <input type="number" id="inp-reach" value="0.5" step="0.1"
              style="width:80px; padding:12px; border-radius:12px; border:1px solid #ddd; text-align:center; font-size:1.1rem; font-weight:700;"
              onchange="saveReach(this.value)">
          </div>
          <div class="setting-item" style="flex-direction:row; align-items:center; justify-content:space-between;">
            <span class="s-label">Â§ñÈÉ®Âá∫Âäõ (Pin 13)</span>
            <label class="switch"><input type="checkbox" id="chk-pin13" onchange="togglePin13(this)"><span
                class="slider round"></span></label>
          </div>
          <div class="setting-item">
            <div class="s-header"><span class="s-label">ÂÖ®„Çµ„Éº„ÉúÂêåÊôÇË™øÊï¥</span><span class="s-val"
                id="all-servo-val">270¬∞</span></div>
            <input type="range" min="90" max="270" value="270" step="1" class="input-slider"
              oninput="setAllServos(this.value)" style="width:100%;">
          </div>
        </div>
      </div>

      <!-- VIEW: HISTORY -->
      <div id="view-history" class="view-container" style="display:none;">
        <div class="header" style="display:flex; align-items:center; gap:10px;">
          <button onclick="showMain()"
            style="background:none; border:none; color:var(--text-main); cursor:pointer; padding:0; font-size:2rem; font-weight:bold;">‚Üê</button>
          <h1>Â±•Ê≠¥</h1>
        </div>
        <div id="history-list" class="card" style="padding:10px 20px;"></div>
      </div>

      <!-- MODAL -->
      <div class="completion-modal" id="completion-modal">
        <div class="completion-content">
          <div class="completion-title">ÂÆåÊàêÔºÅ</div>
          <div class="completion-details">
            <div class="detail-row"><span class="detail-label">„Éó„É™„Çª„ÉÉ„Éà</span><span class="detail-value"
                id="detail-preset">-</span></div>
            <div class="detail-row"><span class="detail-label">Âº∑„Åï</span><span class="detail-value"
                id="detail-strength">-</span></div>
            <div class="detail-row"><span class="detail-label">ÂõûÊï∞</span><span class="detail-value"
                id="detail-count">-</span></div>
          </div>
          <button class="completion-btn" onclick="closeCompletionModal()">OK</button>
        </div>
      </div>

    </div> <!-- End #app-screen -->
  </div> <!-- End .phone-frame -->

  <button class="capture-btn" onclick="saveImage()">„Çπ„Éû„ÉõÊû†„ÇíÁîªÂÉè„Å®„Åó„Å¶‰øùÂ≠ò</button>

  <script>
    const appScreen = document.getElementById('app-screen');
    let tgtCount = 3;
    let currentPresetName = "„Åµ„Å§„ÅÜ";
    let isRunning = false;
    let isManualStop = false;
    let sessionTotalDur = 0;
    let sessionStartTime = 0;
    let runPreset = "";
    let runStrength = 0;
    let runCount = 0;
    const mockHistory = [
      { time: "2026/01/20 08:30", preset: "„Åµ„Å§„ÅÜ", strength: 50, count: 3 },
      { time: "2026/01/20 08:15", preset: "È´òÂ∞ÇÁîüÁî®", strength: 100, count: 5 },
      { time: "2026/01/19 22:45", preset: "„ÇÑ„Çè„Çâ„Åã", strength: 30, count: 2 }
    ];

    document.addEventListener('DOMContentLoaded', () => { fetchSettings(); });

    function fetchSettings() { updTimeDisp(); setTimeout(() => appScreen.classList.add('ready'), 100); }
    function saveHold(v) { console.log("Set Hold:", v); updTimeDisp(); }
    function saveReach(v) { console.log("Set Reach:", v); updTimeDisp(); }
    function togglePin13(el) { console.log("Pin 13:", el.checked); }
    function updVal(id, v, unit) { document.getElementById(id).innerText = v + unit; }
    function fmtTime(s) { let min = Math.floor(s / 60); let sec = Math.floor(s % 60); return min + ":" + (sec < 10 ? "0" : "") + sec; }
    function updTimeDisp() {
      if (isRunning) return;
      const h = parseFloat(document.getElementById('inp-hold').value) || 0.5;
      const r = parseFloat(document.getElementById('inp-reach').value) || 0.5;
      const total = tgtCount * (h + r + 0.3);
      document.getElementById('time-display').innerText = fmtTime(Math.ceil(total));
    }
    function setCount(n, el) {
      tgtCount = n;
      document.querySelectorAll('.chk-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
      if (!isRunning) updTimeDisp();
    }
    function setPreset(mode, el) {
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
      currentPresetName = el.getAttribute('data-name');
      const s = document.getElementById('inp-str');
      let count = 3;
      if (mode === 'soft') { s.value = 30; count = 2; }
      if (mode === 'normal') { s.value = 50; count = 3; }
      if (mode === 'kosen') { s.value = 100; count = 5; }
      updVal('str-disp', s.value, '%');
      tgtCount = count;
      document.querySelectorAll('.chk-btn').forEach(b => { if (parseInt(b.innerText) === count) { b.classList.add('active'); } else { b.classList.remove('active'); } });
      if (!isRunning) updTimeDisp();
    }
    function showSettings() { document.getElementById('view-main').style.display = 'none'; document.getElementById('view-settings').style.display = 'block'; document.getElementById('view-history').style.display = 'none'; }
    function showHistory() { document.getElementById('view-main').style.display = 'none'; document.getElementById('view-settings').style.display = 'none'; document.getElementById('view-history').style.display = 'block'; fetchHistory(); }
    function showMain() { document.getElementById('view-settings').style.display = 'none'; document.getElementById('view-history').style.display = 'none'; document.getElementById('view-main').style.display = 'block'; }
    function fetchHistory() {
      const list = document.getElementById('history-list');
      list.innerHTML = "";
      if (mockHistory.length === 0) { list.innerHTML = "<div style='padding:20px; text-align:center; color:#888;'>Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>"; return; }
      mockHistory.forEach(item => {
        const row = document.createElement('div');
        row.className = 'history-row';
        row.innerHTML =
          '<div class="h-info">' +
          '<span class="h-preset">' + item.preset + '</span>' +
          '<div class="h-detail">Âº∑„Åï:' + item.strength + '% / ' + item.count + 'Âõû</div>' +
          '</div>' +
          '<div class="h-time">' + item.time + '</div>';
        list.appendChild(row);
      });
    }
    function start() {
      const s = document.getElementById('inp-str').value;
      isManualStop = false; isRunning = true;
      appScreen.classList.add('running');
      document.getElementById('status-badge').innerText = "Ê∫ñÂÇô‰∏≠...";
      sessionStartTime = Date.now();
      runPreset = currentPresetName; runStrength = s; runCount = tgtCount;
      const h = parseFloat(document.getElementById('inp-hold').value) || 0.5;
      const r = parseFloat(document.getElementById('inp-reach').value) || 0.5;
      sessionTotalDur = tgtCount * (h + r + 0.3);
      if (sessionTotalDur < 1) sessionTotalDur = 1;
      console.log("Start");
    }
    function stop() { isManualStop = true; finishSession(); }
    function animateLoop() {
      if (isRunning && sessionTotalDur > 0) {
        const now = Date.now();
        const elapsedSec = (now - sessionStartTime) / 1000;
        const remaining = Math.max(0, sessionTotalDur - elapsedSec);
        document.getElementById('time-display').innerText = fmtTime(Math.ceil(remaining));
        if (elapsedSec < 1) document.getElementById('status-badge').innerText = "Ê∫ñÂÇô‰∏≠...";
        else if (elapsedSec < sessionTotalDur) {
          const cycleDur = sessionTotalDur / tgtCount;
          const currentCycle = Math.min(tgtCount, Math.ceil(elapsedSec / cycleDur));
          const phase = Math.floor(elapsedSec * 2) % 2;
          const txt = phase === 0 ? "Êè°„Çä‰∏≠" : "‰øùÊåÅ‰∏≠";
          document.getElementById('status-badge').innerText = txt + " (" + currentCycle + "/" + tgtCount + ")";
        }
        let pct = (elapsedSec / sessionTotalDur) * 100;
        if (pct < 0) pct = 0; if (pct > 100) pct = 100;
        document.getElementById('yt-fill').style.width = pct + "%";
        if (remaining <= 0 && !isManualStop) {
          finishSession();
          const d = new Date();
          const timeStr = d.getFullYear() + "/" + (d.getMonth() + 1).toString().padStart(2, '0') + "/" + d.getDate().toString().padStart(2, '0') + " " + d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
          mockHistory.unshift({ time: timeStr, preset: runPreset, strength: runStrength, count: runCount });
        }
      }
      requestAnimationFrame(animateLoop);
    }
    requestAnimationFrame(animateLoop);
    function finishSession() {
      isRunning = false;
      appScreen.classList.remove('running');
      document.getElementById('status-badge').innerText = "ÂæÖÊ©ü‰∏≠";
      document.getElementById('yt-fill').style.width = '0%';
      updTimeDisp();
      if (!isManualStop) { showCompletionModal(); }
      isManualStop = false;
    }
    function showCompletionModal() {
      const modal = document.getElementById('completion-modal');
      document.getElementById('detail-preset').innerText = runPreset;
      document.getElementById('detail-strength').innerText = runStrength + '%';
      document.getElementById('detail-count').innerText = runCount + 'Âõû';
      modal.classList.add('show');
    }
    function closeCompletionModal() { document.getElementById('completion-modal').classList.remove('show'); }
    function setAllServos(angle) {
      document.getElementById('all-servo-val').innerText = angle + '¬∞';
    }

    // --- CAPTURE FIX ---
    function createDummySlider(input) {
      const val = parseInt(input.value);
      const min = parseInt(input.min);
      const max = parseInt(input.max);
      const percentage = ((val - min) / (max - min)) * 100;

      const dummyWrapper = document.createElement('div');
      dummyWrapper.className = 'dummy-slider';
      dummyWrapper.style.cssText = 'width: 100%; height: 44px; display: flex; align-items: center; position: relative;';

      const track = document.createElement('div');
      const bg = input.id === 'inp-str'
        ? 'linear-gradient(90deg, #e5e5ea 0%, #56d364 50%, #1a7f37 100%)'
        : '#e5e5ea';
      track.style.cssText = `width: 100%; height: 14px; background: ${bg}; border-radius: 7px; position: absolute; left: 0;`;

      const thumb = document.createElement('div');
      thumb.style.cssText = `
        width: 32px; height: 32px; border-radius: 50%; background: #ffffff;
        border: 0.5px solid rgba(0,0,0,0.04);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        position: absolute;
        left: calc(${percentage}% - 16px);
      `;

      dummyWrapper.appendChild(track);
      dummyWrapper.appendChild(thumb);
      return dummyWrapper;
    }

    function saveImage() {
      const target = document.getElementById('capture-target');

      // html2canvas„ÅÆË®≠ÂÆöÔºöonclone„Åß„Ç≠„É£„Éó„ÉÅ„É£Áî®„ÅÆDOM„ÇíÊìç‰Ωú„Åô„Çã
      html2canvas(target, {
        backgroundColor: null,
        scale: 2,
        onclone: (clonedDoc) => {
          const clonedTarget = clonedDoc.getElementById('capture-target');

          // 1. „Çπ„É©„Ç§„ÉÄ„Éº„Çí„ÉÄ„Éü„ÉºÂåñÔºà„ÇØ„É≠„Éº„É≥ÂÅ¥„ÅßÂÆüË°åÔºâ
          const sliders = clonedTarget.querySelectorAll('input[type=range].input-slider');
          sliders.forEach(input => {
            const dummy = createDummySlider(input);
            input.parentNode.insertBefore(dummy, input.nextSibling);
            input.style.display = 'none';
          });

          // 2. „Éú„Çø„É≥„ÅÆËâ≤„ÇíCSSÂ§âÊï∞„Åã„ÇâÁõ¥Êé•ÊåáÂÆöËâ≤„Å´Êõ∏„ÅçÊèõ„Åà„ÇãÔºàÂåñ„ÅëÂØæÁ≠ñÔºâ
          // Start„Éú„Çø„É≥
          const btnStart = clonedTarget.querySelector('.btn-start');
          if (btnStart) {
            btnStart.style.background = '#2ea043';
            btnStart.style.boxShadow = 'none'; // „Ç∑„É£„Éâ„Ç¶Èô§Âéª„ÅßÂ¥©„ÇåÈò≤Ê≠¢
          }
          // Stop„Éú„Çø„É≥ (Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çå„Å∞)
          const btnStop = clonedTarget.querySelector('.btn-stop');
          if (btnStop && getComputedStyle(btnStop).display !== 'none') {
            btnStop.style.background = '#ff3b30'; // Ëµ§Ëâ≤„ÇíÂº∑Âà∂
            btnStop.style.boxShadow = 'none';
          }

          // 3. „Åù„ÅÆ‰ªñÂ¥©„Çå„ÇÑ„Åô„ÅÑÁÆáÊâÄ„ÅÆÂæÆË™øÊï¥
          // Êï∞Â≠ó„Éï„Ç©„É≥„Éà„ÅÆÂ§™„Åï„ÇíÂº∑Âà∂
          const timeBig = clonedTarget.querySelector('.time-big');
          if (timeBig) timeBig.style.fontFamily = "'Inter', sans-serif";
        }
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'onigiri_mockup_fixed.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
  </script>
</body>

</html>